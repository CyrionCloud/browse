[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor

# Virtual framebuffer - creates a virtual display :99
[program:xvfb]
command=Xvfb :99 -screen 0 %(ENV_SCREEN_WIDTH)sx%(ENV_SCREEN_HEIGHT)sx%(ENV_SCREEN_DEPTH)s -ac +extension GLX +render -noreset
autorestart=true
priority=100
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0

# Wait for Xvfb to be ready before starting other services
[program:wait-for-xvfb]
command=bash -c "while ! xdpyinfo -display :99 > /dev/null 2>&1; do sleep 0.1; done; echo 'Xvfb ready'"
autorestart=false
startsecs=0
priority=150
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0



# Socat Proxy - forwards external 9222 to internal Chrome 9223
[program:socat]
command=socat TCP-LISTEN:9222,fork,bind=0.0.0.0 TCP:127.0.0.1:9223
autorestart=true
priority=350
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0

# go2rtc - WebRTC Streaming Server
[program:go2rtc]
command=/usr/local/bin/go2rtc -config /etc/go2rtc.yaml
autorestart=true
priority=360
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0

# Google Chrome with remote debugging enabled
[program:chrome]
command=/usr/local/bin/start-chrome.sh
user=chrome
autorestart=true
priority=400
startretries=10
startsecs=10
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
environment=DISPLAY=":99",HOME="/home/chrome",SCREEN_WIDTH="1920",SCREEN_HEIGHT="1080"

