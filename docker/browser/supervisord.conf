[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor

# Virtual framebuffer - creates a virtual display :99
[program:xvfb]
command=Xvfb :99 -screen 0 %(ENV_SCREEN_WIDTH)sx%(ENV_SCREEN_HEIGHT)sx%(ENV_SCREEN_DEPTH)s -ac +extension GLX +render -noreset
autorestart=true
priority=100
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0

# Wait for Xvfb to be ready before starting other services
[program:wait-for-xvfb]
command=bash -c "while ! xdpyinfo -display :99 > /dev/null 2>&1; do sleep 0.1; done; echo 'Xvfb ready'"
autorestart=false
startsecs=0
priority=150
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0

# VNC Server - shares the Xvfb display
[program:x11vnc]
command=x11vnc -display :99 -forever -shared -nopw -rfbport 5900 -xkb -noxrecord -noxfixes -noxdamage -repeat
autorestart=true
priority=200
startretries=10
startsecs=3
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0

# noVNC WebSocket proxy - allows browser to connect via WebSocket
[program:novnc]
command=websockify --web=/usr/share/novnc 6080 localhost:5900
autorestart=true
priority=300
startretries=10
startsecs=3
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0

# Google Chrome with remote debugging enabled
[program:chrome]
command=google-chrome-stable
    --no-sandbox
    --disable-dev-shm-usage
    --disable-gpu
    --disable-software-rasterizer
    --remote-debugging-port=9222
    --remote-debugging-address=0.0.0.0
    --display=:99
    --window-size=%(ENV_SCREEN_WIDTH)s,%(ENV_SCREEN_HEIGHT)s
    --window-position=0,0
    --disable-background-timer-throttling
    --disable-backgrounding-occluded-windows
    --disable-renderer-backgrounding
    --disable-features=TranslateUI
    --disable-ipc-flooding-protection
    --disable-hang-monitor
    --no-first-run
    --no-default-browser-check
    --user-data-dir=/home/chrome/.config/google-chrome
    about:blank
user=chrome
autorestart=true
priority=400
startretries=10
startsecs=5
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
environment=DISPLAY=":99",HOME="/home/chrome"
